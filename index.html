<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCSE Study Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            /* Foundational Palette (Defaulting to Dark) */
            --color-background: #0D0D0D;
            --color-surface: #171717;
            --color-surface-hover: #212121;
            --color-outline: #2C2C2C;
            --color-outline-hover: #444444;

            --color-text-primary: #F5F5F5;
            --color-text-secondary: #8A8A8A;
            --color-text-tertiary: #5A5A5A;
            
            /* Accent Palette */
            --color-accent: #FFFFFF;
            --color-accent-text: #000000;
            
            /* RAG Palette for high contrast */
            --rag-red: #EF4444;
            --rag-amber: #D97706;
            --rag-green: #059669;

            /* Sizing & Spacing System (4px base) - Base sizes for desktop */
            --space-1: 4px;  --space-2: 8px;  --space-3: 12px; --space-4: 16px;
            --space-5: 20px; --space-6: 24px; --space-7: 32px; --space-8: 40px;

            /* Shape System */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 999px;

            /* Typography System - Base sizes for desktop */
            --font-size-xs: 12px; --font-size-sm: 14px; --font-size-md: 16px;
            --font-size-lg: 20px; --font-size-xl: 24px; --font-size-xxl: 32px;

            /* Motion System */
            --easing: cubic-bezier(0.16, 1, 0.3, 1);
            --transition-speed: 0.25s;
        }

        /* Light Theme */
        html[data-theme="light"] {
            --color-background: #F5F5F5;
            --color-surface: #FFFFFF;
            --color-surface-hover: #F0F0F0;
            --color-outline: #E0E0E0;
            --color-outline-hover: #BDBDBD;
            --color-text-primary: #212121;
            --color-text-secondary: #757575;
            --color-text-tertiary: #9E9E9E;
            --color-accent: #0D0D0D;
            --color-accent-text: #FFFFFF;
        }

        /* UFC Theme */
        html[data-theme="ufc"] {
            --color-background: #0A0A0A;
            --color-surface: #141414;
            --color-surface-hover: #1F1F1F;
            --color-outline: #4A3F2B;
            --color-outline-hover: #75623C;
            --color-text-primary: #EAEAEA;
            --color-text-secondary: #9D8C6C;
            --color-text-tertiary: #666;
            --color-accent: #D93025;
            --color-accent-text: #FFFFFF;
        }

        /* UFC Theme Specific Overrides */
        html[data-theme="ufc"] body {
            background-image: radial-gradient(ellipse at top, rgba(25, 25, 25, 0.9) 0%, rgba(10, 10, 10, 1) 100%);
        }
        html[data-theme="ufc"] .onboarding-card h1,
        html[data-theme="ufc"] .spec-header h1,
        html[data-theme="ufc"] .paper-header,
        html[data-theme="ufc"] .countdown-item .value {
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        html[data-theme="ufc"] .md-button:not(.text) {
             box-shadow: 0 0 15px -2px var(--color-accent);
        }
        
        @keyframes slideUpFadeIn { from { opacity: 0; transform: translateY(var(--space-2)); } to { opacity: 1; transform: translateY(0); } }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html { scroll-behavior: smooth; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-background); 
            color: var(--color-text-primary); 
            line-height: 1.6; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 var(--space-6); }
        .hidden { display: none !important; }

        /* Main Views */
        .onboarding, .main-dashboard, .spec-view { 
            animation: slideUpFadeIn 0.6s var(--easing) both; 
        }

        .onboarding, .main-dashboard {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-dashboard > .container {
            flex-grow: 1;
        }

        /* Modal Base Styles */
        .modal { 
            display: flex; position: fixed; inset: 0; padding: var(--space-4); z-index: 1000; 
            align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(12px); opacity: 0; visibility: hidden;
            transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease;
        }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--color-surface); border-radius: var(--radius-xl); width: 100%; max-width: 560px;
            border: 1px solid var(--color-outline); display: flex; flex-direction: column; max-height: 90vh;
            transform: scale(0.95); transition: transform var(--transition-speed) var(--easing), background-color var(--transition-speed) ease, border-color var(--transition-speed) ease;
        }
        .modal.visible .modal-content { transform: scale(1); }
        .modal-header {
            padding: var(--space-5) var(--space-6); border-bottom: 1px solid var(--color-outline); flex-shrink: 0;
        }
        .modal-header h2 { font-size: var(--font-size-lg); font-weight: 700; text-align: center; }
        .modal-body { padding: var(--space-6); flex-grow: 1; overflow-y: auto; }
        .modal-footer {
            display: flex; justify-content: flex-end; gap: var(--space-3); padding: var(--space-4) var(--space-6);
            border-top: 1px solid var(--color-outline); background-color: var(--color-surface);
            border-bottom-left-radius: var(--radius-xl); border-bottom-right-radius: var(--radius-xl); flex-shrink: 0;
        }

        /* Onboarding Screen */
        .onboarding { justify-content: center; }
        .onboarding-card {
            background: var(--color-surface); border-radius: var(--radius-xl); padding: var(--space-8); width: 100%; 
            max-width: 720px; border: 1px solid var(--color-outline); text-align: center;
            margin: auto;
        }
        .onboarding-card h1 { font-size: var(--font-size-xxl); font-weight: 700; margin-bottom: var(--space-2); }
        .onboarding-card p { color: var(--color-text-secondary); font-size: var(--font-size-md); margin-bottom: var(--space-7); max-width: 450px; margin-left: auto; margin-right: auto;}
        .onboarding-card .subject-grid { margin-bottom: var(--space-7); }
        
        /* Countdown Timer */
        .countdown-container { text-align: center; padding: var(--space-7) 0; }
        .countdown-container h2 { font-size: var(--font-size-sm); font-weight: 600; color: var(--color-text-secondary); margin-bottom: var(--space-4); letter-spacing: 0.5px; text-transform: uppercase; }
        .countdown-timer { display: flex; justify-content: center; gap: var(--space-4); }
        .countdown-item { background: var(--color-surface); border: 1px solid var(--color-outline); padding: var(--space-4); border-radius: var(--radius-lg); min-width: 90px; }
        .countdown-item .value { font-size: var(--font-size-xxl); font-weight: 700; line-height: 1.1; color: var(--color-accent); }
        .countdown-item .label { font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-2); }

        /* Subject Grid */
        .subject-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-3); }
        .subject-card { 
            border-radius: var(--radius-lg); padding: var(--space-5); cursor: pointer; 
            transition: all var(--transition-speed) var(--easing); border: 1px solid var(--color-outline); 
            background-color: var(--color-surface); display: flex; align-items: center; justify-content: space-between;
        }
        .subject-card:hover { transform: translateY(-4px); border-color: var(--color-outline-hover); background-color: var(--color-surface-hover); }
        .subject-card.selected { border-color: var(--color-accent); background-color: var(--color-surface); }
        .subject-card h3 { font-size: var(--font-size-md); font-weight: 600; color: var(--color-text-primary); pointer-events: none; }
        .subject-card.selected h3 { color: var(--color-accent); }
        .exam-board-pill {
            font-weight: 600; padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full); background-color: var(--color-background);
            color: var(--color-text-secondary); border: 1px solid var(--color-outline);
            text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0;
            font-size: clamp(0.6rem, 1.5vw, 0.75rem);
        }
        
        /* Spec View Header */
        .spec-header {
            position: sticky; top: 0; background-color: rgba(13, 13, 13, 0.8);
            backdrop-filter: blur(12px); z-index: 101; border-bottom: 1px solid var(--color-outline);
        }
        .spec-header .container {
            display: flex;
            align-items: center;
            flex-wrap: wrap; 
            justify-content: space-between;
            padding-top: var(--space-4);
            padding-bottom: var(--space-4);
            gap: var(--space-4);
        }
        #spec-view > .container {
             margin-top: var(--space-7);
        }

        html[data-theme="light"] .spec-header { background-color: rgba(245, 245, 245, 0.8); }
        html[data-theme="ufc"] .spec-header { background-color: rgba(10, 10, 10, 0.8); }

        .spec-header-main { display: flex; align-items: center; gap: var(--space-4); flex-grow: 1; min-width: 0; }
        .spec-header h1 {
            font-weight: 700; display: flex; align-items: center;
            gap: var(--space-3);
            font-size: clamp(1.25rem, 3.5vw, var(--font-size-xl));
        }
        
        /* Summary Bar Filter */
        .spec-summary-bar { display: flex; flex-wrap: wrap; justify-content: center; gap: var(--space-2); }
        .summary-item {
            display: flex; align-items: center; gap: var(--space-2);
            background-color: var(--color-surface); border: 1px solid var(--color-outline);
            padding: var(--space-2) var(--space-3); border-radius: var(--radius-md);
            font-size: var(--font-size-sm); font-weight: 600; color: var(--color-text-secondary);
            cursor: pointer; transition: all var(--transition-speed) ease;
        }
        .summary-item:hover { background-color: var(--color-surface-hover); border-color: var(--color-outline-hover); color: var(--color-text-primary); }
        .summary-item.active {
            border-color: var(--color-accent);
            color: var(--color-text-primary);
        }
        .summary-item .dot { width: 8px; height: 8px; border-radius: 50%; }
        .summary-item .dot.red { background-color: var(--rag-red); }
        .summary-item .dot.amber { background-color: var(--rag-amber); }
        .summary-item .dot.green { background-color: var(--rag-green); }

        /* Science Tabs for Combined Science */
        .science-tabs {
            display: flex;
            gap: var(--space-3);
            width: 100%;
        }
        .science-tab {
            flex: 1; /* Make tabs take up equal space */
            padding: var(--space-3) var(--space-2);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-outline);
            background-color: var(--color-surface);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-weight: 600;
            font-size: var(--font-size-sm);
            text-align: center;
        }
        .science-tab:hover {
            background-color: var(--color-surface-hover);
            border-color: var(--color-outline-hover);
            color: var(--color-text-primary);
        }
        .science-tab.active {
            background-color: var(--color-accent);
            color: var(--color-accent-text);
            border-color: var(--color-accent);
            box-shadow: 0 4px 8px -2px rgba(0,0,0,0.1);
        }
        html[data-theme="ufc"] .science-tab.active {
            box-shadow: 0 0 12px -2px var(--color-accent);
        }

        /* Buttons */
        .md-button { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-2); height: 44px; padding: 0 var(--space-5); border-radius: var(--radius-md); border: 1px solid var(--color-accent); background: var(--color-accent); color: var(--color-accent-text); font-size: var(--font-size-sm); font-weight: 600; cursor: pointer; transition: all var(--transition-speed) var(--easing); text-decoration: none; }
        .md-button:hover { transform: scale(1.03); }
        .md-button:active { transform: scale(0.98); }
        .md-button:disabled { background: var(--color-surface); color: var(--color-text-tertiary); border-color: var(--color-outline); cursor: not-allowed; transform: none;}
        .md-button .material-icons { font-size: var(--font-size-lg); }
        .md-button.text { background: transparent; color: var(--color-text-primary); border-color: var(--color-outline); }
        .md-button.text:hover { background-color: var(--color-surface-hover); border-color: var(--color-outline-hover); }
        .dashboard-footer { text-align: center; margin-top: var(--space-7); display: flex; justify-content: center; gap: var(--space-3); padding-bottom: var(--space-4); }
        .dashboard-divider { display: flex; align-items: center; text-align: center; margin: var(--space-7) 0; color: var(--color-text-secondary); }
        .dashboard-divider::before, .dashboard-divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--color-outline); }
        .dashboard-divider:not(:empty)::before { margin-right: 1em; }
        .dashboard-divider:not(:empty)::after { margin-left: 1em; }
        .dashboard-divider h2 { font-size: var(--font-size-sm); text-transform: uppercase; letter-spacing: 0.5px; }

        /* No Subjects Message */
        #noSubjectsMessage {
            text-align: center;
            padding: var(--space-8);
            color: var(--color-text-secondary);
        }
        #noSubjectsMessage p { margin-bottom: var(--space-4); }

        /* Specification Content */
        .paper-section { background: var(--color-surface); border: 1px solid var(--color-outline); border-radius: var(--radius-xl); margin-bottom: var(--space-7); overflow: hidden; }
        .paper-header { padding: var(--space-5) var(--space-6); font-size: var(--font-size-lg); font-weight: 700; display: flex; justify-content: space-between; align-items: center; gap: var(--space-4); }
        .topic { border-top: 1px solid var(--color-outline); }
        .topic-header { padding: var(--space-3) var(--space-6); background-color: var(--color-background); }
        .topic-header-content { font-weight: 600; font-size: var(--font-size-sm); color: var(--color-text-secondary); }
        .subtopic { padding: var(--space-4) var(--space-6); border-top: 1px solid var(--color-outline); transition: background-color var(--transition-speed) ease; display: flex; justify-content: space-between; align-items: center; gap: var(--space-4); }
        .subtopic:hover { background-color: var(--color-surface-hover); }
        .subtopic-title { font-size: var(--font-size-sm); flex-grow: 1; padding-right: var(--space-4); }
        .subtopic-details { display: flex; align-items: center; gap: var(--space-2); flex-shrink: 0; position: relative; }
        
        /* Topic Progress Bar */
        .topic-progress-bar {
            width: 100%; background-color: var(--color-outline); height: 4px;
            border-radius: var(--radius-full); overflow: hidden; margin-top: var(--space-2);
        }
        .topic-progress-fill {
            width: 0%; height: 100%;
            transition: width 0.5s var(--easing), background 0.5s var(--easing);
        }

        /* Timestamp Tooltip */
        .review-timestamp-tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            margin-bottom: var(--space-3); background-color: var(--color-surface-hover);
            color: var(--color-text-primary); padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md); font-size: var(--font-size-xs); font-weight: 500;
            white-space: nowrap; opacity: 0; visibility: hidden; pointer-events: none;
            transition: opacity var(--transition-speed) ease, margin-bottom var(--transition-speed) ease;
        }
        .subtopic-details:hover .review-timestamp-tooltip {
            opacity: 1; visibility: visible; margin-bottom: var(--space-2);
        }
        
        /* RAG dot styling */
        .rag-selector { display: flex; align-items: center; gap: var(--space-2); flex-shrink: 0; }
        .rag-dot {
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent; transition: all var(--transition-speed) var(--easing);
            opacity: 0.6; display: flex; align-items: center; justify-content: center;
        }
        .rag-dot:hover { opacity: 1; transform: scale(1.1); }
        .rag-dot .check-icon { display: none; font-size: 16px; font-weight: 700; color: var(--color-text-primary); }
        
        .rag-dot.selected {
            opacity: 1; transform: scale(1.1); border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 16px -2px var(--shadow-color);
        }
        html[data-theme="light"] .rag-dot.selected { border-color: rgba(0, 0, 0, 0.2); }
        .rag-dot.selected .check-icon { display: block; }
        
        .rag-dot.red { background-color: var(--rag-red); --shadow-color: var(--rag-red); }
        .rag-dot.amber { background-color: var(--rag-amber); --shadow-color: var(--rag-amber); }
        .rag-dot.green { background-color: var(--rag-green); --shadow-color: var(--rag-green); }
        
        /* Filtered out items */
        .subtopic.filtered-out, .topic.filtered-out, .paper-section.filtered-out { display: none; }

        /* No Results Message */
        #noResultsMessage {
            text-align: center;
            padding: var(--space-8);
            color: var(--color-text-secondary);
        }

        /* Theme Selector Styles */
        .theme-selector {
            margin-top: var(--space-4);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-4);
        }
        .theme-option {
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border: 2px solid var(--color-outline);
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-speed) ease;
        }
        .theme-option:hover {
            border-color: var(--color-outline-hover);
            background-color: var(--color-surface-hover);
        }
        .theme-option.active {
            border-color: var(--color-accent);
            box-shadow: 0 0 12px -2px var(--color-accent);
        }
        .theme-preview {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 50px;
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
            border: 1px solid var(--color-outline);
            padding: var(--space-2);
        }
        .theme-preview span {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .theme-option h4 {
            font-weight: 600;
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
        }
        .theme-description {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-4);
        }

        /* Desktop-only styles */
        @media (min-width: 769px) {
            .subject-grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }

            /* Center header content for combined science on desktop */
            #spec-view.is-combined-science .spec-header .container {
                flex-direction: column;
                align-items: center;
            }

            #spec-view.is-combined-science .spec-header-main {
                position: relative;
                width: 100%;
                justify-content: center;
                flex-grow: 0;
            }

            #spec-view.is-combined-science #backToDashBtn {
                position: absolute;
                left: 0;
            }
        }

        /* Mobile-only styles and refined sizing */
        @media (max-width: 768px) {
            :root {
                --space-1: 3px;  --space-2: 6px;  --space-3: 10px; --space-4: 14px;
                --space-5: 18px; --space-6: 20px; --space-7: 28px; --space-8: 36px;
                --font-size-xs: 11px; --font-size-sm: 13px; --font-size-md: 15px;
                --font-size-lg: 18px; --font-size-xl: 22px; --font-size-xxl: 26px;
            }

            .container { padding: 0 var(--space-4); }
            #main-dashboard .container {
                padding-bottom: 30px; /* Space at the bottom for mobile dashboard */
            }

            .onboarding-card { padding: var(--space-7) var(--space-4); }
            .onboarding-card h1 { font-size: var(--font-size-xl); }
            .countdown-container { padding: var(--space-6) 0; }
            .countdown-timer { gap: var(--space-2); }
            .countdown-item { padding: var(--space-3); min-width: 65px; border-radius: var(--radius-md); }
            .countdown-item .value { font-size: var(--font-size-xl); }
            .countdown-item .label { font-size: 10px; margin-top: var(--space-1); }

            /* REFINED Mobile Header Layout */
            .spec-header .container {
                flex-direction: column;
                align-items: stretch; /* Make items take full width */
                gap: var(--space-3);
                padding-top: var(--space-3);
                padding-bottom: var(--space-3);
            }
            .spec-header-main {
                position: relative;
                width: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            #backToDashBtn {
                position: absolute;
                left: 0;
            }
            .spec-header h1 { 
                font-size: var(--font-size-lg); 
                text-align: center;
            }
            .spec-summary-bar { 
                justify-content: center; 
                flex-wrap: wrap; 
            }
            .science-tab {
                font-size: var(--font-size-xs);
                padding: var(--space-2) var(--space-1);
            }
            
            .paper-section { border-radius: var(--radius-lg); }
            .paper-header { padding: var(--space-4); font-size: var(--font-size-md); }
            .topic-header { padding: var(--space-3) var(--space-4); }
            .subtopic { flex-direction: column; align-items: flex-start; gap: var(--space-3); padding: var(--space-4); }
            .subtopic-details { width: 100%; justify-content: space-between; }
            .subtopic-title { padding-right: 0; }

            .md-button { height: 40px; padding: 0 var(--space-4); font-size: var(--font-size-sm); }
            .modal-content { border-radius: var(--radius-lg); }
            .modal-header, .modal-footer { padding: var(--space-4); }
            .modal-body { padding: var(--space-5); }
        }
    </style>
</head>
<body>
    <!-- Onboarding Screen -->
    <div id="onboarding" class="onboarding">
        <div class="onboarding-card">
            <h1>Welcome to Your Study Hub</h1>
            <p>Select your subjects to build a personalized tracker and take control of your revision.</p>
            <div class="subject-grid" id="onboardingSubjectGrid"></div>
            <button class="md-button" id="continueBtn" disabled>
                <span>Continue</span>
                <span class="material-icons">arrow_forward</span>
            </button>
        </div>
    </div>
    
    <!-- Main Dashboard View -->
    <div id="main-dashboard" class="main-dashboard hidden">
        <div class="container">
            <div class="countdown-container">
                <h2>Time until May 2026 GCSE Exams</h2>
                <div class="countdown-timer" id="countdownTimer"></div>
            </div>
            <div class="dashboard-divider" id="dashboardDivider"><h2>Your Subjects</h2></div>
            <div class="subject-grid" id="dashboardSubjectGrid"></div>
            <div id="noSubjectsMessage" class="hidden">
                <p>You haven't added any subjects yet.</p>
                <button class="md-button" id="addSubjectsFromDashBtn">
                    <span class="material-icons">add</span>
                    <span>Add Subjects</span>
                </button>
            </div>
            <div class="dashboard-footer">
                <button class="md-button text" id="editSubjectsBtn">
                    <span class="material-icons">edit</span>
                    <span>Edit Subjects</span>
                </button>
                <button class="md-button text" id="openThemeSettingsBtn">
                    <span class="material-icons">settings</span>
                    <span>Settings</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Subject Specification View -->
    <div id="spec-view" class="spec-view hidden">
        <div class="spec-header">
            <div class="container">
                <div class="spec-header-main">
                    <button class="md-button text" id="backToDashBtn" title="Back to Dashboard">
                        <span class="material-icons">arrow_back</span>
                    </button>
                    <h1 id="specSubjectTitle"></h1>
                </div>
                <!-- Science tabs will be inserted here by JS -->
                <div class="spec-summary-bar" id="specSummaryBar"></div>
            </div>
        </div>
        <div class="container">
            <div id="specContent"></div>
            <div id="noResultsMessage" class="hidden">
                <p>No topics match the current filter.</p>
            </div>
        </div>
    </div>

    <!-- Edit Subjects Modal -->
    <div id="editSubjectsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Edit Subjects</h2></div>
            <div class="modal-body">
                <div class="subject-grid" id="settingsSubjectGrid"></div>
            </div>
            <div class="modal-footer">
                <button class="md-button text" id="cancelEditSubjects">Cancel</button>
                <button class="md-button" id="saveEditSubjects">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Theme Settings Modal -->
    <div id="themeSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Settings</h2></div>
            <div class="modal-body">
                <h3 style="font-weight: 600;">Appearance</h3>
                <p class="theme-description">Choose a theme to personalize your dashboard.</p>
                <div class="theme-selector">
                    <!-- Theme options are dynamically inserted here by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="md-button text" id="closeThemeSettingsBtn">Done</button>
            </div>
        </div>
    </div>

    <script>
        // Data containing all subject specifications
        const subjectsData = {
            'Mathematics (Higher)': {
                specifications: {
                    'Edexcel': {
                        'Paper 1: Non-Calculator': {
                            '1. Number': ['Order of operations', 'Negative numbers', 'Fractions, decimals and percentages', 'Powers, roots and standard form', 'Surds', 'Estimation and bounds'],
                            '2. Algebra': ['Algebraic manipulation', 'Solving equations and inequalities', 'Sequences', 'Graphs of equations and functions'],
                            '3. Geometry and measures': ['Properties of shapes', 'Constructions and loci', 'Perimeter, area and volume', 'Transformations', 'Pythagoras and trigonometry']
                        },
                        'Paper 2: Calculator': {
                            '1. Number': ['Calculators and accuracy', 'Ratio, proportion and rates of change', 'Percentages and financial maths'],
                            '2. Algebra': ['Further algebraic manipulation', 'Harder equations', 'Graphs of functions', 'Gradients and lines'],
                            '3. Geometry and measures': ['Mensuration (area and volume)', 'Circle theorems', 'Vectors', 'Advanced trigonometry (Sine/Cosine rule)']
                        },
                        'Paper 3: Calculator': {
                            '1. Statistics': ['Sampling', 'Data representation (diagrams and charts)', 'Averages and spread', 'Histograms and cumulative frequency'],
                            '2. Probability': ['Basic probability', 'Tree diagrams', 'Venn diagrams and conditional probability'],
                            '3. Ratio and proportion': ['Direct and inverse proportion', 'Growth and decay', 'Problem solving with ratio']
                        }
                    }
                }
            },
            'English Language': {
                specifications: {
                    'AQA': {
                        'Paper 1: Explorations in Creative Reading and Writing': {
                            'Section A: Reading': ['Q1: Identify explicit information', 'Q2: Explain language features', 'Q3: Analyse structure', 'Q4: Evaluate a statement about the text'],
                            'Section B: Writing': ['Descriptive or narrative writing', 'Using language devices', 'Structuring a story', 'Spelling, punctuation and grammar']
                        },
                        'Paper 2: Writers\' Viewpoints and Perspectives': {
                            'Section A: Reading': ['Q1: Identify true statements', 'Q2: Summarise differences', 'Q3: Explain language features', 'Q4: Compare writers\' viewpoints'],
                            'Section B: Writing': ['Writing to present a viewpoint (e.g., letter, speech, article)', 'Structuring an argument', 'Using rhetorical devices', 'Spelling, punctuation and grammar']
                        }
                    }
                }
            },
            'English Literature': {
                specifications: {
                    'AQA': {
                        'Paper 1: Shakespeare and the 19th-Century Novel': {
                            'Shakespeare: Macbeth': ['Character analysis (Macbeth, Lady Macbeth, etc.)', 'Key themes (ambition, guilt, supernatural)', 'Context (Jacobean era, divine right of kings)', 'Language, structure, and form'],
                            '19th-Century Novel: A Christmas Carol': ['Character analysis (Scrooge, The Ghosts)', 'Key themes (poverty, redemption, social responsibility)', 'Context (Victorian society, industrial revolution)', 'Narrative techniques and structure']
                        },
                        'Paper 2: Modern Texts and Poetry': {
                            'Modern Text: An Inspector Calls': ['Character analysis (Birlings, Inspector Goole)', 'Dramatic devices (dramatic irony, timing)', 'Key themes (social responsibility, class, gender)', 'Social and historical context (1912 vs 1945)'],
                            'Poetry Anthology: Power and Conflict': ['Analysing 15 set poems', 'Comparing poems on themes (e.g., effects of conflict, reality of war)', 'Analysing language and structure', 'Understanding context'],
                            'Unseen Poetry': ['Analysing an unseen poem', 'Comparing two unseen poems']
                        }
                    }
                }
            },
            'Biology': {
                specifications: {
                    'AQA': {
                        'Paper 1': {
                            '1. Cell Biology': ['Prokaryotic and eukaryotic cells', 'Microscopy', 'Cell division (mitosis, meiosis)', 'Transport in cells (diffusion, osmosis, active transport)'],
                            '2. Organisation': ['The human digestive system', 'The heart and blood vessels', 'Breathing and gas exchange', 'Plant tissues, organs and systems'],
                            '3. Infection and Response': ['Communicable diseases', 'Human defence systems', 'Vaccination', 'Antibiotics and drug development'],
                            '4. Bioenergetics': ['Photosynthesis', 'Respiration (aerobic and anaerobic)', 'Metabolism']
                        },
                        'Paper 2': {
                            '5. Homeostasis and Response': ['The human nervous system', 'The endocrine system (hormones)', 'Homeostasis in action (blood glucose, water balance)', 'Hormones in human reproduction'],
                            '6. Inheritance, Variation and Evolution': ['Reproduction', 'DNA and the genome', 'Genetic inheritance', 'Variation and evolution (natural selection)', 'Selective breeding and genetic engineering'],
                            '7. Ecology': ['Communities and ecosystems', 'Organisation of an ecosystem (food chains, predator-prey cycles)', 'Biodiversity and human impact', 'Trophic levels and biomass', 'Food security']
                        }
                    }
                }
            },
            'Chemistry': {
                specifications: {
                    'AQA': {
                        'Paper 1: Atomic Structure and the Periodic Table': {
                            '1. Atomic Structure': ['Atoms, elements and compounds', 'Mixtures', 'The model of the atom', 'Relative atomic mass', 'Electronic structure'],
                            '2. The Periodic Table': ['Development of the periodic table', 'Group 0 (Noble Gases)', 'Group 1 (Alkali Metals)', 'Group 7 (Halogens)'],
                            '3. Structure and Bonding': ['Covalent, ionic and metallic bonding', 'Properties of different structures', 'Structure and bonding of carbon (diamond, graphite, graphene)'],
                            '4. Quantitative Chemistry': ['Conservation of mass and balanced equations', 'Relative formula mass', 'Moles (Higher Tier)', 'Amounts of substances in equations (Higher Tier)'],
                            '5. Chemical Changes': ['Reactivity of metals', 'Reactions of acids', 'Electrolysis'],
                            '6. Energy Changes': ['Exothermic and endothermic reactions', 'Reaction profiles']
                        },
                        'Paper 2: The Rate and Extent of Chemical Change': {
                            '7. Rate of Reaction': ['Calculating rates of reactions', 'Factors which affect the rate of reaction', 'Reversible reactions and dynamic equilibrium'],
                            '8. Organic Chemistry': ['Crude oil and hydrocarbons', 'Reactions of alkanes and alkenes', 'Alcohols, carboxylic acids and esters', 'Polymers'],
                            '9. Chemical Analysis': ['Pure substances', 'Chromatography', 'Identification of common gases and ions'],
                            '10. Chemistry of the Atmosphere': ['Composition and evolution of the atmosphere', 'Greenhouse gases', 'Common atmospheric pollutants'],
                            '11. Using Resources': ['Using the Earth’s resources and sustainable development', 'Potable water', 'Life cycle assessment and recycling', 'The Haber process and NPK fertilisers']
                        }
                    }
                }
            },
            'Physics': {
                specifications: {
                    'AQA': {
                        'Paper 1': {
                            '1. Energy': ['Energy stores and systems', 'Conservation of energy', 'Work, power and efficiency', 'Energy resources'],
                            '2. Electricity': ['Standard circuit diagram symbols', 'Series and parallel circuits', 'Current, potential difference and resistance', 'Domestic uses and safety', 'Energy transfers in appliances', 'The National Grid'],
                            '3. Particle Model of Matter': ['Density of materials', 'Changes of state', 'Internal energy', 'Specific latent heat and specific heat capacity', 'Particle motion in gases'],
                            '4. Atomic Structure': ['Models of the atom', 'Atoms and isotopes', 'Radioactive decay and nuclear radiation', 'Nuclear equations', 'Half-lives and the random nature of decay', 'Hazards and uses of radiation', 'Nuclear fission and fusion']
                        },
                        'Paper 2': {
                            '5. Forces': ['Scalar and vector quantities', 'Contact and non-contact forces', 'Gravity', 'Resultant forces', 'Work done and energy transfer', 'Forces and elasticity', 'Moments, levers and gears', 'Pressure in fluids', 'Forces and motion (velocity, acceleration)', 'Newton\'s Laws of Motion', 'Stopping distance'],
                            '6. Waves': ['Transverse and longitudinal waves', 'Properties of waves (frequency, wavelength)', 'Reflection and refraction of waves', 'Sound waves', 'Waves for detection and exploration (ultrasound, seismic waves)'],
                            '7. Magnetism and Electromagnetism': ['Poles of a magnet', 'Magnetic fields', 'The motor effect', 'The generator effect', 'Transformers'],
                            '8. Space Physics': ['The Solar System', 'The life cycle of a star', 'Orbital motion', 'The expanding Universe (Red-shift, Big Bang theory)']
                        }
                    }
                }
            },
            'Combined Science (Higher)': {
                specifications: {
                    'AQA': {
                        'Biology Paper 1': {
                            '1. Cell Biology': ['Prokaryotic and eukaryotic cells', 'Microscopy', 'Cell division (mitosis)', 'Transport in cells (diffusion, osmosis, active transport)'],
                            '2. Organisation': ['The human digestive system', 'The heart and blood vessels', 'Breathing and gas exchange', 'Health issues', 'Plant tissues, organs and systems'],
                            '3. Infection and Response': ['Communicable diseases', 'Viral, bacterial, protist and fungal diseases', 'Human defence systems', 'Vaccination', 'Antibiotics and painkillers'],
                            '4. Bioenergetics': ['Photosynthesis', 'Respiration (aerobic and anaerobic)', 'Metabolism']
                        },
                        'Biology Paper 2': {
                            '5. Homeostasis and Response': ['The human nervous system', 'The endocrine system', 'Control of blood glucose concentration', 'Hormones in human reproduction', 'Contraception'],
                            '6. Inheritance, Variation and Evolution': ['Reproduction (sexual and asexual)', 'Meiosis', 'DNA and the genome', 'Genetic inheritance', 'Variation', 'Evolution and natural selection', 'Evidence for evolution'],
                            '7. Ecology': ['Communities', 'Abiotic and biotic factors', 'Adaptations', 'Organisation of an ecosystem', 'Biodiversity and the effect of human interaction on ecosystems']
                        },
                        'Chemistry Paper 1': {
                            '8. Atomic Structure and the Periodic Table': ['The periodic table', 'Properties of transition metals', 'Structure and bonding', 'Properties of substances', 'Quantitative chemistry (moles, concentrations)'],
                            '9. Chemical Changes': ['Reactivity of metals', 'Reactions of acids', 'Electrolysis'],
                            '10. Energy Changes': ['Exothermic and endothermic reactions', 'Reaction profiles', 'Energy change in reactions']
                        },
                        'Chemistry Paper 2': {
                            '11. The Rate and Extent of Chemical Change': ['Rate of reaction', 'Reversible reactions and dynamic equilibrium', 'Equilibrium (Le Chatelier\'s principle)'],
                            '12. Organic Chemistry': ['Hydrocarbons', 'Alcohols, carboxylic acids', 'Polymers'],
                            '13. Chemical Analysis': ['Purity, formulations and chromatography', 'Identification of common gases and ions'],
                            '14. Chemistry of the Atmosphere': ['History and composition of the atmosphere', 'Greenhouse gases', 'Atmospheric pollutants'],
                            '15. Using Resources': ['Using the Earth’s resources and sustainable development', 'Life cycle assessment', 'Potable water']
                        },
                        'Physics Paper 1': {
                            '16. Energy': ['Energy changes in a system', 'Conservation and dissipation of energy', 'National and global energy resources'],
                            '17. Electricity': ['Current, potential difference and resistance', 'Series and parallel circuits', 'Domestic uses and safety', 'Energy transfers', 'The National Grid'],
                            '18. Particle Model of Matter': ['Changes of state and the particle model', 'Internal energy and energy transfers', 'Particle model and pressure'],
                            '19. Atomic Structure': ['Atoms and isotopes', 'Atoms and nuclear radiation', 'Hazards and uses of radioactive emissions']
                        },
                        'Physics Paper 2': {
                            '20. Forces': ['Forces and their interactions', 'Work done and energy transfer', 'Forces and elasticity', 'Moments, levers and gears', 'Pressure and pressure differences in fluids', 'Forces and motion', 'Resultant forces', 'Newton\'s Laws of Motion'],
                            '21. Waves': ['Wave properties', 'Transverse and longitudinal waves', 'Reflection of waves', 'Sound waves', 'Waves for detection and exploration'],
                            '22. Magnetism and Electromagnetism': ['Permanent and induced magnetism', 'The motor effect', 'Induced potential']
                        }
                    }
                }
            },
            'Geography': {
                specifications: {
                    'AQA': {
                        'Paper 1: Living with the Physical Environment': {
                            '1. The Challenge of Natural Hazards': ['Tectonic hazards (earthquakes, volcanoes)', 'Weather hazards (tropical storms, UK extreme weather)', 'Climate change (evidence, causes, effects, management)'],
                            '2. The Living World': ['Ecosystems', 'Tropical rainforests (case study)', 'Hot deserts (case study)', 'Cold environments (optional)'],
                            '3. Physical Landscapes in the UK': ['UK physical landscapes overview', 'Coastal landscapes (processes, landforms, management)', 'River landscapes (processes, landforms, management)', 'Glacial landscapes (optional)']
                        },
                        'Paper 2: Challenges in the Human Environment': {
                            '4. Urban Issues and Challenges': ['The urban world (urbanisation trends)', 'Urban change in a major NEE/LIC city (case study)', 'Urban change in a major UK city (case study)', 'Sustainable urban development'],
                            '5. The Changing Economic World': ['The development gap', 'Economic change in a major NEE/LIC country (case study)', 'Economic change in the UK'],
                            '6. The Challenge of Resource Management': ['Resource management overview (food, water, energy)', 'Food management', 'Water management', 'Energy management']
                        },
                        'Paper 3: Geographical Applications': {
                            'Issue Evaluation': ['Pre-release resource booklet analysis', 'Making a geographical decision'],
                            'Fieldwork': ['Understanding fieldwork enquiry', 'Physical and human geography fieldwork', 'Data collection, presentation and analysis', 'Conclusion and evaluation']
                        }
                    }
                }
            },
            'Computer Science': {
                specifications: {
                    'OCR': {
                        'Component 01: Computer Systems': {
                            '1.1 Systems Architecture': ['The purpose of the CPU', 'Von Neumann architecture', 'CPU performance (clock speed, cores, cache)', 'Embedded systems'],
                            '1.2 Memory and Storage': ['RAM and ROM', 'Virtual memory', 'Flash memory', 'Primary and secondary storage', 'Units of data storage', 'Data compression'],
                            '1.3 Computer Networks, Connections and Protocols': ['LAN and WAN', 'Factors affecting network performance', 'Client-server and peer-to-peer networks', 'Network hardware', 'The Internet', 'IP addressing and DNS', 'Network security (firewalls, proxies, encryption)'],
                            '1.4 Network Security': ['Forms of attack (malware, phishing, social engineering)', 'Threats to networks (brute-force, DoS)', 'Identifying and preventing vulnerabilities'],
                            '1.5 System Software': ['The function of the operating system', 'User interface types', 'Memory management and multitasking', 'Utility software (encryption, defragmentation, compression)'],
                            '1.6 Ethical, Legal, Cultural and Environmental Impacts': ['Impacts of digital technology', 'Privacy issues', 'Legislation (Data Protection Act, Computer Misuse Act)', 'Open source vs proprietary software']
                        },
                        'Component 02: Computational Thinking, Algorithms and Programming': {
                            '2.1 Algorithms': ['Computational thinking (abstraction, decomposition, algorithmic thinking)', 'Standard searching algorithms (binary, linear)', 'Standard sorting algorithms (bubble, merge, insertion)', 'Producing algorithms (pseudocode, flowcharts)'],
                            '2.2 Programming Fundamentals': ['Variables, constants, operators, assignment', 'Sequence, selection, iteration', 'Data types', 'Arrays (one-dimensional and two-dimensional)', 'String manipulation', 'File handling operations', 'Subroutines (functions, procedures)'],
                            '2.3 Producing Robust Programs': ['Defensive design', 'Input validation', 'Maintainability (comments, indentation)', 'Testing (iterative, final/terminal)', 'Types of errors (syntax, logic)', 'Test data (normal, boundary, invalid, erroneous)'],
                            '2.4 Boolean Logic': ['Simple logic diagrams (AND, OR, NOT)', 'Combining Boolean operators', 'Truth tables'],
                            '2.5 Programming Languages and IDEs': ['Characteristics of languages (high-level, low-level)', 'Translators (compilers, interpreters)', 'IDE tools (editors, error diagnostics, run-time environment)']
                        }
                    }
                }
            }
        };

        // --- Application State ---
        let selectedSubjects = [];
        let ragStatus = {};
        let currentTheme = 'dark';
        let currentRagFilter = 'all';
        let countdownInterval;
        let currentContext = { subject: null };
        const views = {};
        const modals = {};
        let lastFocusedElement;

        // --- Core Application Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // Cache view and modal elements
            Object.assign(views, {onboarding: document.getElementById('onboarding'),dashboard: document.getElementById('main-dashboard'),spec: document.getElementById('spec-view')});
            document.querySelectorAll('.modal').forEach(modal => { modals[modal.id] = modal; });

            // Load data from localStorage
            try { 
                const data = JSON.parse(localStorage.getItem('studyTrackerDataV2'));
                if(data) { 
                    selectedSubjects = data.selectedSubjects || []; 
                    ragStatus = data.ragStatus || {};
                }
            } catch (e) { console.error("Could not parse data, starting fresh.", e); }
            
            // Load theme from localStorage
            loadTheme();

            // Determine initial view
            if (localStorage.getItem('studyTrackerDataV2')) { 
                showView('dashboard'); 
            } else { 
                showView('onboarding'); 
            }
            addEventListeners();
        });

        function saveData() { localStorage.setItem('studyTrackerDataV2', JSON.stringify({ selectedSubjects, ragStatus })); }

        function addEventListeners() {
            document.body.addEventListener('click', e => {
                const target = e.target;
                const closest = (selector) => target.closest(selector);
                
                if (target.classList.contains('modal')) { hideModal(target.id); }

                const button = closest('button');
                if (button) {
                    const id = button.id;
                    if (id === 'continueBtn') { if (selectedSubjects.length > 0) { saveData(); showView('dashboard'); } }
                    else if (id === 'editSubjectsBtn' || id === 'addSubjectsFromDashBtn') { renderEditSubjectsModal(); showModal('editSubjectsModal'); }
                    else if (id === 'openThemeSettingsBtn') { renderThemeSettingsModal(); showModal('themeSettingsModal'); }
                    else if (id === 'backToDashBtn') showView('dashboard');
                    
                    if (id === 'cancelEditSubjects' || id === 'closeThemeSettingsBtn') hideModal(closest('.modal').id);
                    if (id === 'saveEditSubjects') handleSaveSettings();

                    if(button.classList.contains('science-tab')) {
                        handleScienceTabClick(button);
                    }
                }
                
                const subjectCard = closest('.subject-card');
                if (subjectCard) {
                    if(document.getElementById('main-dashboard').contains(subjectCard)) showSpecView(subjectCard.dataset.subject);
                    if(document.getElementById('onboarding').contains(subjectCard)) toggleOnboardingSubject(subjectCard);
                    if(document.getElementById('editSubjectsModal').contains(subjectCard)) toggleSettingsSubject(subjectCard);
                }

                const ragDot = closest('.rag-dot');
                if (ragDot) { handleRagSelection(ragDot); }

                const filterTrigger = closest('.summary-item');
                if (filterTrigger) {
                    currentRagFilter = filterTrigger.dataset.filter;
                    document.querySelectorAll('.summary-item').forEach(btn => btn.classList.remove('active'));
                    filterTrigger.classList.add('active');
                    applyRagFilter();
                }

                const themeOption = closest('.theme-option');
                if (themeOption) {
                    applyTheme(themeOption.dataset.theme);
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const visibleModal = document.querySelector('.modal.visible');
                    if (visibleModal) { hideModal(visibleModal.id); }
                }
            });
        }

        // --- Theme Management ---
        function loadTheme() {
            const savedTheme = localStorage.getItem('studyTrackerTheme') || 'dark';
            applyTheme(savedTheme);
        }

        function applyTheme(themeName) {
            document.documentElement.dataset.theme = themeName;
            currentTheme = themeName;
            localStorage.setItem('studyTrackerTheme', themeName);
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.theme === themeName);
            });
        }

        function renderThemeSettingsModal() {
            const selector = document.querySelector('#themeSettingsModal .theme-selector');
            if (!selector) return;
            const themes = [
                { id: 'light', name: 'Light', colors: ['#212121', '#757575', '#0D0D0D'], bg: '#F5F5F5' },
                { id: 'dark', name: 'Dark', colors: ['#F5F5F5', '#8A8A8A', '#FFFFFF'], bg: '#171717' },
                { id: 'ufc', name: 'UFC', colors: ['#EAEAEA', '#9D8C6C', '#D93025'], bg: '#141414' }
            ];
            selector.innerHTML = themes.map(theme => `
                <div class="theme-option ${currentTheme === theme.id ? 'active' : ''}" data-theme="${theme.id}">
                    <div class="theme-preview" style="background-color: ${theme.bg};">
                        <span style="background-color: ${theme.colors[0]}"></span>
                        <span style="background-color: ${theme.colors[1]}"></span>
                        <span style="background-color: ${theme.colors[2]}"></span>
                    </div>
                    <h4>${theme.name}</h4>
                </div>
            `).join('');
        }

        // --- RAG & Filtering ---
        function handleRagSelection(element) {
            const subtopicKey = element.closest('.rag-selector').dataset.subtopicKey;
            const newStatus = element.dataset.status;

            if (element.classList.contains('selected')) {
                delete ragStatus[subtopicKey];
            } else {
                ragStatus[subtopicKey] = { status: newStatus, timestamp: new Date().toISOString() };
            }
            saveData();

            const subtopicEl = element.closest('.subtopic');
            if (subtopicEl) {
                const newSubtopicEl = createSubtopicElement( subtopicEl.dataset.subject, subtopicEl.dataset.examBoard, subtopicEl.dataset.paper, subtopicEl.dataset.topic, subtopicEl.dataset.subtopic );
                subtopicEl.parentNode.replaceChild(newSubtopicEl, subtopicEl);
            }
            
            updateAllTopicProgress();
            renderSummaryBar();
            applyRagFilter();
        }

        function applyRagFilter() {
            const topics = document.querySelectorAll('.science-content-panel:not(.hidden) .topic, #specContent > .paper-section .topic');
            topics.forEach(topic => {
                let hasVisibleSubtopic = false;
                const subtopics = topic.querySelectorAll('.subtopic');
                subtopics.forEach(subtopic => {
                    const subtopicKey = subtopic.querySelector('.rag-selector').dataset.subtopicKey;
                    const entry = ragStatus[subtopicKey];
                    const status = entry ? entry.status : null;

                    if (currentRagFilter === 'all' || status === currentRagFilter) {
                        subtopic.classList.remove('filtered-out');
                        hasVisibleSubtopic = true;
                    } else {
                        subtopic.classList.add('filtered-out');
                    }
                });
                topic.classList.toggle('filtered-out', !hasVisibleSubtopic);
            });

            const paperSections = document.querySelectorAll('.science-content-panel:not(.hidden) .paper-section, #specContent > .paper-section');
            paperSections.forEach(paper => {
                const hasVisibleTopic = paper.querySelector('.topic:not(.filtered-out)');
                paper.classList.toggle('filtered-out', !hasVisibleTopic);
            });

            const noResultsMessage = document.getElementById('noResultsMessage');
            const hasVisibleContent = document.querySelector('.science-content-panel:not(.hidden), #specContent > .paper-section:not(.filtered-out)');
            if (noResultsMessage) {
                noResultsMessage.classList.toggle('hidden', hasVisibleContent);
            }
        }
        
        // --- View & Modal Management ---
        function showView(viewName) { 
            Object.values(views).forEach(v => v.classList.add('hidden')); 
            if (views[viewName]) views[viewName].classList.remove('hidden'); 
            if (viewName === 'onboarding') renderOnboardingContent(); 
            if (viewName === 'dashboard') { renderDashboardContent(); startCountdown(); } 
            if (viewName !== 'dashboard') stopCountdown();
        }
        
        function showModal(modalId) { 
            const modal = modals[modalId];
            if(!modal) return;
            lastFocusedElement = document.activeElement;
            modal.classList.add('visible');
            modal.addEventListener('keydown', handleFocusTrap);
            const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (focusableElements.length > 0) { setTimeout(() => focusableElements[0].focus(), 100); }
        }
        
        function hideModal(modalId) { 
            const modal = modals[modalId];
            if(!modal) return;
            modal.classList.remove('visible');
            modal.removeEventListener('keydown', handleFocusTrap);
            if(lastFocusedElement) { lastFocusedElement.focus(); }
        }

        function handleFocusTrap(e) {
            if (e.key !== 'Tab') return;
            const modal = e.currentTarget;
            const focusableElements = Array.from(modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(el => !el.disabled && el.offsetParent !== null);
            if(focusableElements.length === 0) return;
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            if (e.shiftKey) { if (document.activeElement === firstElement) { lastElement.focus(); e.preventDefault(); } } 
            else { if (document.activeElement === lastElement) { firstElement.focus(); e.preventDefault(); } }
        }
        
        function showSpecView(subject) {
            const specView = document.getElementById('spec-view');
            specView.classList.remove('is-combined-science'); // Always reset first

            const existingTabs = document.querySelector('.science-tabs');
            if (existingTabs) existingTabs.remove();

            currentContext.subject = subject;
            document.getElementById('specSubjectTitle').innerHTML = `<span>${subject}</span>`;
            
            if (subject === 'AQA Combined Science (Higher)') {
                specView.classList.add('is-combined-science');
            }

            currentRagFilter = 'all';
            renderSpecContent(subject);
            showView('spec');
        }

        function handleScienceTabClick(tab) {
            const science = tab.dataset.science;
            document.querySelectorAll('.science-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            document.querySelectorAll('.science-content-panel').forEach(panel => {
                panel.classList.toggle('hidden', panel.dataset.science !== science);
            });
            
            updateAllTopicProgress();
            renderSummaryBar();
            applyRagFilter();
        }

        // --- Content Rendering ---
        function renderSpecContent(subject) {
            const contentEl = document.getElementById('specContent');
            const subjectInfo = subjectsData[subject];
            if (!subjectInfo) { contentEl.innerHTML = '<p>Subject data not available.</p>'; return; }
            const examBoard = Object.keys(subjectInfo.specifications)[0];
            const specification = subjectInfo.specifications[examBoard];
            if (!specification) { contentEl.innerHTML = '<p>Specification data not available.</p>'; return; }

            contentEl.innerHTML = '';

            if (subject === 'AQA Combined Science (Higher)') {
                const tabContainer = document.createElement('div');
                tabContainer.className = 'science-tabs';
                tabContainer.innerHTML = `
                    <button class="science-tab active" data-science="biology">Biology</button>
                    <button class="science-tab" data-science="chemistry">Chemistry</button>
                    <button class="science-tab" data-science="physics">Physics</button>
                `;
                document.querySelector('.spec-header .container').insertBefore(tabContainer, document.getElementById('specSummaryBar'));

                const papersByScience = { biology: [], chemistry: [], physics: [] };
                Object.keys(specification).forEach(paperName => {
                    if (paperName.toLowerCase().includes('biology')) papersByScience.biology.push(paperName);
                    else if (paperName.toLowerCase().includes('chemistry')) papersByScience.chemistry.push(paperName);
                    else if (paperName.toLowerCase().includes('physics')) papersByScience.physics.push(paperName);
                });

                Object.keys(papersByScience).forEach(science => {
                    const sciencePanel = document.createElement('div');
                    sciencePanel.className = 'science-content-panel';
                    sciencePanel.dataset.science = science;
                    if (science !== 'biology') sciencePanel.classList.add('hidden');

                    papersByScience[science].forEach(paper => {
                        sciencePanel.appendChild(createPaperElement(subject, examBoard, specification, paper));
                    });
                    contentEl.appendChild(sciencePanel);
                });
            } else {
                Object.keys(specification).forEach((paper, i) => {
                    contentEl.appendChild(createPaperElement(subject, examBoard, specification, paper, i));
                });
            }

            updateAllTopicProgress();
            renderSummaryBar();
            applyRagFilter();
        }

        function createPaperElement(subject, examBoard, specification, paper, index = 0) {
            const paperEl = document.createElement('div');
            paperEl.className = 'paper-section';
            paperEl.style.animationDelay = `${index * 100}ms`;
            paperEl.dataset.paper = paper;
            paperEl.dataset.subject = subject;
            paperEl.appendChild(createPaperHeaderElement(subject, paper));
            Object.keys(specification[paper]).forEach(topic => {
                const topicEl = document.createElement('div');
                topicEl.className = 'topic';
                topicEl.dataset.topicName = topic;
                topicEl.innerHTML = `<div class="topic-header"><div class="topic-header-content">${topic}</div><div class="topic-progress-bar"><div class="topic-progress-fill"></div></div></div>`;
                specification[paper][topic].forEach(subtopic => topicEl.appendChild(createSubtopicElement(subject, examBoard, paper, topic, subtopic)));
                paperEl.appendChild(topicEl);
            });
            return paperEl;
        }
        
        function createSubtopicElement(subject, examBoard, paper, topic, subtopic) { 
            const subtopicEl = document.createElement('div'); 
            subtopicEl.className = 'subtopic'; 
            subtopicEl.dataset.subject = subject; subtopicEl.dataset.examBoard = examBoard;
            subtopicEl.dataset.paper = paper; subtopicEl.dataset.topic = topic; subtopicEl.dataset.subtopic = subtopic;

            const subtopicKey = `${subject}-${paper}-${topic}-${subtopic}`.replace(/[^a-zA-Z0-9-]/g, '-').toLowerCase();
            const ragEntry = ragStatus[subtopicKey];
            const currentStatus = ragEntry ? ragEntry.status : null;
            const timestamp = ragEntry ? ragEntry.timestamp : null;

            const formattedDate = timestamp 
                ? `Last reviewed: ${new Date(timestamp).toLocaleString('en-GB', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', '')}`
                : 'Not reviewed yet';

            subtopicEl.innerHTML = `
                <div class="subtopic-title">${subtopic}</div>
                <div class="subtopic-details">
                    <div class="review-timestamp-tooltip">${formattedDate}</div>
                    <div class="rag-selector" data-subtopic-key="${subtopicKey}">
                        <div class="rag-dot red ${currentStatus === 'red' ? 'selected' : ''}" data-status="red" title="Not Confident"><span class="material-icons check-icon">check</span></div>
                        <div class="rag-dot amber ${currentStatus === 'amber' ? 'selected' : ''}" data-status="amber" title="Needs Review"><span class="material-icons check-icon">check</span></div>
                        <div class="rag-dot green ${currentStatus === 'green' ? 'selected' : ''}" data-status="green" title="Confident"><span class="material-icons check-icon">check</span></div>
                    </div>
                </div>`;
            return subtopicEl; 
        }

        function createPaperHeaderElement(subject, paper) { 
            const paperEl = document.createElement('div'); 
            paperEl.className = 'paper-header'; 
            paperEl.dataset.paperKey = `${subject}-${paper}`; 
            paperEl.innerHTML = `<span>${paper}</span>`; 
            return paperEl; 
        }

        function updateAllTopicProgress() {
            document.querySelectorAll('.science-content-panel:not(.hidden) .topic, #specContent > .paper-section .topic').forEach(topicEl => {
                const subtopics = topicEl.querySelectorAll('.subtopic');
                const totalSubtopics = subtopics.length;
                if (totalSubtopics === 0) return;

                let score = 0;
                let amberCount = 0;
                let greenCount = 0;
                subtopics.forEach(st => {
                    const key = st.querySelector('.rag-selector').dataset.subtopicKey;
                    const status = ragStatus[key]?.status;
                    if (status === 'green') {
                        score += 2;
                        greenCount++;
                    } else if (status === 'amber') {
                        score += 1;
                        amberCount++;
                    }
                });
                
                const maxScore = totalSubtopics * 2;
                const percentage = maxScore > 0 ? (score / maxScore) * 100 : 0;
                const fillEl = topicEl.querySelector('.topic-progress-fill');
                
                if (fillEl) {
                    fillEl.style.width = `${percentage}%`;
                    
                    let gradientStyle;
                    const totalRatedCount = amberCount + greenCount;

                    if (greenCount > 0 && amberCount === 0) {
                        gradientStyle = 'var(--rag-green)';
                    } else if (greenCount === 0 && amberCount > 0) {
                        gradientStyle = 'var(--rag-amber)';
                    } else if (totalRatedCount > 0) {
                        const amberRatio = amberCount / totalRatedCount;
                        const amberStopPercentage = amberRatio * 100;
                        gradientStyle = `linear-gradient(to right, var(--rag-amber), var(--rag-amber) ${amberStopPercentage}%, var(--rag-green) ${amberStopPercentage}%)`;
                    } else {
                        gradientStyle = 'var(--rag-green)';
                    }
                    fillEl.style.background = gradientStyle;
                }
            });
        }

        function renderSummaryBar() {
            const summaryBar = document.getElementById('specSummaryBar');
            if (!summaryBar) return;
            const counts = { red: 0, amber: 0, green: 0, all: 0 };
            
            const visibleSelectors = document.querySelectorAll('.science-content-panel:not(.hidden) .rag-selector, #specContent > .paper-section .rag-selector');
            counts.all = visibleSelectors.length;

            visibleSelectors.forEach(el => {
                const key = el.dataset.subtopicKey;
                const status = ragStatus[key]?.status;
                if (status && counts.hasOwnProperty(status)) {
                    counts[status]++;
                }
            });
            
            const unrated = counts.all - (counts.red + counts.amber + counts.green);

            summaryBar.innerHTML = `
                <div class="summary-item ${currentRagFilter === 'all' ? 'active' : ''}" data-filter="all" title="Show All Topics"><span>All (${counts.all})</span></div>
                <div class="summary-item ${currentRagFilter === 'red' ? 'active' : ''}" data-filter="red" title="Filter 'Not Confident'"><span class="dot red"></span><span>${counts.red}</span></div>
                <div class="summary-item ${currentRagFilter === 'amber' ? 'active' : ''}" data-filter="amber" title="Filter 'Needs Review'"><span class="dot amber"></span><span>${counts.amber}</span></div>
                <div class="summary-item ${currentRagFilter === 'green' ? 'active' : ''}" data-filter="green" title="Filter 'Confident'"><span class="dot green"></span><span>${counts.green}</span></div>
            `;
        }
        
        // --- Subject Selection & Settings ---
        function toggleOnboardingSubject(card) { const subject = card.dataset.subject; const isSelected = card.classList.toggle('selected'); if (isSelected) { if (!selectedSubjects.includes(subject)) selectedSubjects.push(subject); } else { selectedSubjects = selectedSubjects.filter(s => s !== subject); } updateContinueButton(); }
        function toggleSettingsSubject(card) { card.classList.toggle('selected'); updateSaveButtonState(); }
        function updateContinueButton() { const btn = document.getElementById('continueBtn'); if (!btn) return; btn.disabled = selectedSubjects.length === 0; const text = btn.querySelector('span:first-child'); text.textContent = selectedSubjects.length > 0 ? `Continue with ${selectedSubjects.length} subject${selectedSubjects.length > 1 ? 's' : ''}` : 'Continue'; }
        
        function handleSaveSettings() { 
            selectedSubjects = Array.from(document.querySelectorAll('#settingsSubjectGrid .subject-card.selected')).map(card => card.dataset.subject); 
            saveData(); 
            hideModal('editSubjectsModal'); 
            showView('dashboard'); 
        }
        function updateSaveButtonState() { const saveBtn = document.getElementById('saveEditSubjects'); if (saveBtn) saveBtn.disabled = document.querySelectorAll('#settingsSubjectGrid .subject-card.selected').length === 0; }
                        
        // --- Misc ---
        function startCountdown() { const el=document.getElementById('countdownTimer');const d=new Date('2026-05-14T09:00:00');function t(){const o=d-new Date;if(o<=0){el.innerHTML="<h2>Exams Started!</h2>";stopCountdown();return}const e=Math.floor(o/864e5),n=Math.floor(o%864e5/36e5),a=Math.floor(o%36e5/6e4),i=Math.floor(o%6e4/1e3);el.innerHTML=`<div class="countdown-item"><span class="value">${e}</span><span class="label">Days</span></div><div class="countdown-item"><span class="value">${n}</span><span class="label">Hours</span></div><div class="countdown-item"><span class="value">${a}</span><span class="label">Minutes</span></div><div class="countdown-item"><span class="value">${i}</span><span class="label">Seconds</span></div>`}stopCountdown();t();countdownInterval=setInterval(t,1e3)}
        function stopCountdown() { clearInterval(countdownInterval); }
        
        function renderOnboardingContent() { const grid = document.getElementById('onboardingSubjectGrid'); if (!grid) return; grid.innerHTML = ''; Object.keys(subjectsData).forEach((subject, index) => { const subjectInfo = subjectsData[subject]; const examBoard = Object.keys(subjectInfo.specifications)[0]; const card = document.createElement('div'); card.className = 'subject-card'; card.dataset.subject = subject; if (selectedSubjects.includes(subject)) card.classList.add('selected'); card.innerHTML = `<h3>${subject}</h3><span class="exam-board-pill">${examBoard}</span>`; card.style.animationDelay = `${index * 50}ms`; grid.appendChild(card); }); updateContinueButton(); }
        function renderDashboardContent() { 
            const grid = document.getElementById('dashboardSubjectGrid');
            const noSubjectsMsg = document.getElementById('noSubjectsMessage');
            const divider = document.getElementById('dashboardDivider');
            
            if (selectedSubjects.length === 0) {
                grid.innerHTML = '';
                grid.classList.add('hidden');
                divider.classList.add('hidden');
                noSubjectsMsg.classList.remove('hidden');
            } else {
                grid.classList.remove('hidden');
                divider.classList.remove('hidden');
                noSubjectsMsg.classList.add('hidden');
                grid.innerHTML = '';
                selectedSubjects.forEach((subject, index) => { 
                    const subjectInfo = subjectsData[subject]; 
                    const examBoard = Object.keys(subjectInfo.specifications)[0]; 
                    const card = document.createElement('div'); 
                    card.className = 'subject-card'; 
                    card.dataset.subject = subject; 
                    card.innerHTML = `<h3>${subject}</h3><span class="exam-board-pill">${examBoard}</span>`; 
                    card.style.animationDelay = `${index * 50}ms`; 
                    grid.appendChild(card); 
                }); 
            }
        }
        function renderEditSubjectsModal() { const grid = document.getElementById('settingsSubjectGrid'); grid.innerHTML = ''; Object.keys(subjectsData).forEach(subject => { const subjectInfo = subjectsData[subject]; const examBoard = Object.keys(subjectInfo.specifications)[0]; const isSelected = selectedSubjects.includes(subject); const card = document.createElement('div'); card.className = 'subject-card'; if (isSelected) card.classList.add('selected'); card.dataset.subject = subject; card.innerHTML = `<h3>${subject}</h3><span class="exam-board-pill">${examBoard}</span>`; grid.appendChild(card); }); updateSaveButtonState(); }

    </script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>

<script>
  // Initialize Firebase using your config
  const firebaseConfig = {
    apiKey: "AIzaSyBNup_F4ceJ6HoRT2FkNZi3hVN-D-JxVuE",
    authDomain: "gcse-study-tracker.firebaseapp.com",
    projectId: "gcse-study-tracker",
    storageBucket: "gcse-study-tracker.firebasestorage.app",
    messagingSenderId: "168245347452",
    appId: "1:168245347452:web:14fcd304253ae9806375f9"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
</script>

<!-- Auth Buttons UI -->
<div id="authContainer" style="margin: 1em 0; text-align: center;">
  <button id="signInGoogle" class="md-button">Sign In with Google</button>
  <button id="signInEmail" class="md-button">Sign In with Email</button>
  <button id="signOut" class="md-button hidden">Sign Out</button>
</div>

<script>
  // Auth Buttons
  const signInGoogleBtn = document.getElementById('signInGoogle');
  const signInEmailBtn = document.getElementById('signInEmail');
  const signOutBtn = document.getElementById('signOut');

  signInGoogleBtn.addEventListener('click', () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(console.error);
  });

  signInEmailBtn.addEventListener('click', () => {
    const email = prompt("Enter your email:");
    const password = prompt("Enter your password:");
    if (email && password) {
      auth.signInWithEmailAndPassword(email, password).catch(err => {
        if (err.code === 'auth/user-not-found') {
          auth.createUserWithEmailAndPassword(email, password).catch(console.error);
        } else {
          console.error(err);
        }
      });
    }
  });

  signOutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  auth.onAuthStateChanged(user => {
    if (user) {
      console.log("Logged in as:", user.email);
      signInGoogleBtn.classList.add('hidden');
      signInEmailBtn.classList.add('hidden');
      signOutBtn.classList.remove('hidden');
      loadUserData(user.uid);
    } else {
      console.log("Logged out");
      signInGoogleBtn.classList.remove('hidden');
      signInEmailBtn.classList.remove('hidden');
      signOutBtn.classList.add('hidden');
      showView('onboarding');
    }
  });

  // Firestore Save
  function saveUserData(uid) {
    db.collection('users').doc(uid).set({
      selectedSubjects: selectedSubjects,
      ragStatus: ragStatus,
      theme: currentTheme
    }).then(() => {
      console.log("Data saved to Firestore");
    }).catch(console.error);
  }

  // Firestore Load
  function loadUserData(uid) {
    db.collection('users').doc(uid).get().then(doc => {
      if (doc.exists) {
        const data = doc.data();
        selectedSubjects = data.selectedSubjects || [];
        ragStatus = data.ragStatus || {};
        currentTheme = data.theme || 'dark';
        applyTheme(currentTheme);
        showView('dashboard');
      } else {
        console.log("No data found, showing onboarding");
        showView('onboarding');
      }
    }).catch(console.error);
  }

  // Update saveData() function
  function saveData() {
    const user = auth.currentUser;
    if (user) {
      saveUserData(user.uid);
    } else {
      console.warn("No user logged in, cannot save");
    }
  }
</script>



</body>
</html>
